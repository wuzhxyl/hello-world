<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>协程</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="o0ig" id="协程">协程</h1><p data-anchor-id="yewn"><code class="code-black">Kotlin</code></p><hr><div class="md-section-divider"></div><h2 data-anchor-id="3jny" id="coroutinescope-接口">CoroutineScope 接口</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="lv3t"><ol class="linenums"><li class="L0"><code><span class="com"># 当界面销毁或协程内出现异常都将导致所有内嵌的协程cancel</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">MyActivity</span><span class="pun">:</span><span class="pln"> </span><span class="typ">AppCompatActivity</span><span class="pun">(),</span><span class="pln"> </span><span class="typ">CoroutineScope</span><span class="pln"> </span><span class="kwd">by</span><span class="pln"> </span><span class="typ">MainScope</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">  </span><span class="kwd">override</span><span class="pln"> fun onDestroy</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L4"><code><span class="pln">    cancel</span><span class="pun">()</span></code></li><li class="L5"><code><span class="pln">  </span><span class="pun">}</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">  fun showSomeData</span><span class="pun">()</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> launch </span><span class="pun">{</span></code></li><li class="L8"><code><span class="pln">    </span><span class="com">// ...</span></code></li><li class="L9"><code><span class="pln">    draw</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="com">// 主线程绘制</span></code></li><li class="L0"><code><span class="pln">  </span><span class="pun">}</span></code></li><li class="L1"><code><span class="pun">}</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="com"># 已重载+运算符，用于添加一个额外的上下文contetx:CoroutineContext</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pun">主线程运行的协程</span></code></li><li class="L6"><code><span class="com"># fun MainScope(): CoroutineScope = ContextScope(SupervisorJob(0 + Dispatchers.Main) </span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="typ">CoroutineScope</span><span class="pun">.</span><span class="pln">launch </span><span class="pun">的失败处理</span><span class="typ">CoroutineExceptionHandler</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="typ">CoroutineScope</span><span class="pun">.</span><span class="pln">async</span><span class="pun">的失败处理</span><span class="typ">Deferred</span><span class="pun">.</span><span class="pln">await</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="typ">GlobalScope</span><span class="pun">被用来新建一些顶层的协程贯穿整个应用的生命周期，并且不会被取消。没有</span><span class="pln">bind</span><span class="pun">任何</span><span class="pln">job</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">coroutineScope</span><span class="pun">继承</span><span class="pln">parent</span><span class="pun">的</span><span class="pln">coroutineContext</span><span class="pun">但实现自己的</span><span class="typ">Job</span><span class="pun">。用于并行工作，当其中任一子协程失败的时候或父协程上下文取消，其余的所有协程也将取消。将会在所有协程完结后返回.</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="typ">CoroutineScope</span><span class="pun">.</span><span class="pln">cancel</span><span class="pun">（</span><span class="pln">cause</span><span class="pun">:</span><span class="typ">CancellationException</span><span class="pun">?=</span><span class="kwd">null</span><span class="pun">）可指定取消的原因</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">EXP</span><span class="pun">:获取数据并展示在</span><span class="pln">UI</span><span class="pun">线程</span></code></li><li class="L9"><code><span class="pln">suspend fun showSomeData</span><span class="pun">()</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> coroutineScope </span><span class="pun">{</span></code></li><li class="L0"><code><span class="pln">  val data </span><span class="pun">=</span><span class="pln"> async</span><span class="pun">(</span><span class="typ">Dispatchers</span><span class="pun">.</span><span class="pln">IO</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com">// load data for UI show</span></code></li><li class="L2"><code><span class="pln">  </span><span class="pun">}</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">  withContext</span><span class="pun">(</span><span class="typ">Dispatchers</span><span class="pun">.</span><span class="typ">Main</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code><span class="pln">    doSomeWork</span><span class="pun">()</span></code></li><li class="L6"><code><span class="pln">    val result </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">.</span><span class="pln">await</span><span class="pun">()</span></code></li><li class="L7"><code><span class="pln">    display</span><span class="pun">(</span><span class="pln">result</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">  </span><span class="pun">}</span></code></li><li class="L9"><code><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="96af" id="lauch">lauch {}</h2><blockquote data-anchor-id="a88m" class="black-blockquote">
  <p>launch { lambda }.join() //等待协程结束</p>
</blockquote><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="f210"><ol class="linenums"><li class="L0"><code><span class="com"># 不阻塞当前线程，创建一个新的协程并返回一个可取消的Job</span></code></li><li class="L1"><code><span class="kwd">public</span><span class="pln"> fun </span><span class="typ">CoroutineScope</span><span class="pun">.</span><span class="pln">launch</span><span class="pun">(</span></code></li><li class="L2"><code><span class="pln">    context</span><span class="pun">:</span><span class="pln"> </span><span class="typ">CoroutineContext</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">EmptyCoroutineContext</span><span class="pun">,</span></code></li><li class="L3"><code><span class="pln">    start</span><span class="pun">:</span><span class="pln"> </span><span class="typ">CoroutineStart</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">CoroutineStart</span><span class="pun">.</span><span class="pln">DEFAULT</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">    block</span><span class="pun">:</span><span class="pln"> suspend </span><span class="typ">CoroutineScope</span><span class="pun">.()</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="typ">Unit</span></code></li><li class="L5"><code><span class="pun">):</span><span class="pln"> </span><span class="typ">Job</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code><span class="pln">    val newContext </span><span class="pun">=</span><span class="pln"> newCoroutineContext</span><span class="pun">(</span><span class="pln">context</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">    val coroutine </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">start</span><span class="pun">.</span><span class="pln">isLazy</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">        </span><span class="typ">LazyStandaloneCoroutine</span><span class="pun">(</span><span class="pln">newContext</span><span class="pun">,</span><span class="pln"> block</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">else</span></code></li><li class="L9"><code><span class="pln">        </span><span class="typ">StandaloneCoroutine</span><span class="pun">(</span><span class="pln">newContext</span><span class="pun">,</span><span class="pln"> active </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">    coroutine</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="pln">start</span><span class="pun">,</span><span class="pln"> coroutine</span><span class="pun">,</span><span class="pln"> block</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">return</span><span class="pln"> coroutine</span></code></li><li class="L2"><code><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="aatb" id="async">async</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="mysr"><ol class="linenums"><li class="L0"><code><span class="pln">async</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">lambda</span><span class="pln"> </span><span class="pun">}.</span><span class="pln">await</span><span class="pun">()待执行完返回结果或抛出异常。异步非阻塞</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="4f7x" id="runblocking">runBlocking {}</h2><blockquote data-anchor-id="1jr6" class="black-blockquote">
  <p>执行新的协程并阻塞当前线程直至内部协程执行完成。不应该用于协程内</p>
</blockquote><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="lgtu"><ol class="linenums"><li class="L0"><code><span class="pun">阻塞主线程直至其内部的协程执行完毕</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="itvc" id="常用函数">常用函数</h2><ul data-anchor-id="7qaj">
<li>GlobeScope 全局协程</li>
<li>suspend func xxx() 协程内的挂起函数</li>
<li>cancelAndJoin() 若协程正在执行计算任务，并没有检查取消的话，则是不能取消的。若可取消，则条件判断isActive</li>
<li>抛出异常的时候可以try{} finally{}捕获问题或通过use {}在协程结束的时候做事情</li>
<li>withTimeout(delay) 设置超时抛出异常</li>
<li>withTimeoutOrNull() 超时则返回null</li>
<li>measureTimeMills() 测量挂起函数执行所需的总时间</li>
<li>async执行需放在coroutineScope中，这样异常取消的时候会取消内部所有协程，避免异常出现</li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="j53k" id="协程上下文及调度器">协程上下文及调度器</h2><blockquote data-anchor-id="pu3m" class="black-blockquote">
  <p>CoroutineContext中包含一个CoroutineDispatcher用来确定哪些线程或线程池来执行协程的执行。协程调度器都可以接收一个可选的CoroutineContext参数，用来显示地为一个新的协程指定调度器</p>
</blockquote><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ilr2"><ol class="linenums"><li class="L0"><code><span class="typ">Dispatchers</span><span class="pun">.</span><span class="typ">Default</span><span class="pun">:</span><span class="pln"> </span><span class="pun">默认是基于</span><span class="pln">CPU</span><span class="pun">核数的共享线程池(至少</span><span class="lit">2</span><span class="pun">个线程)</span></code></li><li class="L1"><code><span class="typ">Dispatchers</span><span class="pun">.</span><span class="pln">IO</span><span class="pun">:</span><span class="pln">      </span><span class="pun">默认是基于</span><span class="pln">CPU</span><span class="pun">核数的共享阻塞线程池(至少</span><span class="lit">2</span><span class="pun">个线程)</span></code></li><li class="L2"><code><span class="typ">Dispatchers</span><span class="pun">.</span><span class="typ">Main</span><span class="pun">:</span><span class="pln"> </span><span class="pun">用于</span><span class="typ">MainThread</span><span class="pun">用来操作</span><span class="pln">UI </span><span class="typ">Objects</span><span class="pun">，可以直接使用或通过</span><span class="typ">MainScope</span><span class="pun">工厂。单线程</span></code></li><li class="L3"><code><span class="typ">Dispatchers</span><span class="pun">.</span><span class="typ">Unconfined</span><span class="pun">:</span><span class="pln"> </span><span class="pun">初始在当前线程，后面</span><span class="pln">suspend</span><span class="pun">在哪个线程调用就在哪个线程执行~</span><span class="pln"> </span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">runBlocking</span><span class="pun">(</span><span class="pln">ctx1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">显示指定上下文</span></code></li><li class="L6"><code><span class="pln">withContext</span><span class="pun">(</span><span class="pln">ctx2</span><span class="pun">)</span><span class="pln"> </span><span class="pun">改变协程的上下文</span></code></li><li class="L7"><code><span class="pun">.</span><span class="kwd">use</span><span class="pln"> </span><span class="pun">{}</span><span class="pln"> </span><span class="pun">使用完后自动释放</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="typ">GlobalScope</span><span class="pun">启动的协程不受当前协程上下文影响</span></code></li><li class="L0"><code><span class="pun">协程命名</span><span class="pln">async</span><span class="pun">(</span><span class="typ">CoroutineName</span><span class="pun">(</span><span class="str">"v1coroutine"</span><span class="pun">)):</span><span class="pln"> </span><span class="pun">协程命名-</span></code></li><li class="L1"><code><span class="pln">launch</span><span class="pun">(</span><span class="typ">Dispatchers</span><span class="pun">.</span><span class="typ">Default</span><span class="pun">+</span><span class="typ">CoroutineName</span><span class="pun">(</span><span class="str">"test"</span><span class="pun">)):</span><span class="pln"> </span><span class="pun">指定线程上下文及协程名</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="q32o" id="线程局部数据的传递">线程局部数据的传递</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="dbr0"><ol class="linenums"><li class="L0"><code><span class="pln">threadLocal</span><span class="pun">.</span><span class="kwd">set</span><span class="pun">(</span><span class="str">"main"</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pun">--</span><span class="pln"> main</span></code></li><li class="L2"><code><span class="pln">val job </span><span class="pun">=</span><span class="pln"> launch</span><span class="pun">(</span><span class="typ">Dispatchers</span><span class="pun">.</span><span class="typ">Default</span><span class="pun">+</span><span class="pln">threadLocal</span><span class="pun">.</span><span class="pln">asContextElement</span><span class="pun">(</span><span class="pln">value</span><span class="pun">=</span><span class="str">"launch"</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">  </span><span class="pun">--</span><span class="pln"> launch</span></code></li><li class="L4"><code><span class="pun">}</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">job</span><span class="pun">.</span><span class="pln">join</span><span class="pun">()</span></code></li><li class="L7"><code><span class="pun">--</span><span class="pln"> main</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="zehn" id="流">流</h2><p data-anchor-id="b64a">flow { <br>
  emit(value) // 提交 <br>
}</p><p data-anchor-id="pekh">flow().collect { } // 获取。仅在collect的时候才执行 <br>
流的emit和collect必须在同一个线程下</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ims3"><ol class="linenums"><li class="L0"><code><span class="com"># 改变流的上下文</span></code></li><li class="L1"><code><span class="pln">fun foo </span><span class="pun">=</span><span class="pln"> flow </span><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="kwd">in</span><span class="pln"> </span><span class="lit">1.</span><span class="pun">.</span><span class="lit">3</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">    </span><span class="typ">Thread</span><span class="pun">.</span><span class="pln">sleep</span><span class="pun">(</span><span class="lit">100</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">    emit</span><span class="pun">(</span><span class="pln">i</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">  </span><span class="pun">}</span></code></li><li class="L6"><code><span class="pun">}.</span><span class="pln">flowOn</span><span class="pun">(</span><span class="typ">Dispatchers</span><span class="pun">.</span><span class="typ">Default</span><span class="pun">)</span><span class="pln"> </span><span class="pun">--</span><span class="pln"> </span><span class="pun">共享线程池</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">main </span><span class="pun">{</span></code></li><li class="L9"><code><span class="pln">  foo</span><span class="pun">().</span><span class="pln">collect </span><span class="pun">{</span><span class="pln">  </span><span class="pun">}</span><span class="pln"> </span><span class="pun">--</span><span class="pln"> </span><span class="pun">主线程</span></code></li><li class="L0"><code><span class="pun">}</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="com"># foo().buffer() 设置缓冲</span></code></li><li class="L3"><code><span class="com"># foo().collectLatest{} 处理最新值</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="zobj" id="值在不同的协程间传递">值在不同的协程间传递</h2><div class="md-section-divider"></div><h4 data-anchor-id="6wt3" id="通道">通道</h4><div class="md-section-divider"></div><h2 data-anchor-id="zs6z" id="全局的异常处理">全局的异常处理</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="upcx"><ol class="linenums"><li class="L0"><code><span class="pln">val handler </span><span class="pun">=</span><span class="pln"> </span><span class="typ">CoroutineExceptionHandler</span><span class="pln"> </span><span class="pun">{</span><span class="pln">_</span><span class="pun">,</span><span class="pln"> exception </span><span class="pun">-&gt;</span><span class="pln"> println</span><span class="pun">(</span><span class="str">"Caught $exception)}</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="str">launch(handler)</span></code></li></ol></pre></div>
</body>
</html>